name: "[Pull Request] TEST ACTIONS"

on:
  pull_request:
    branches: [main]

permissions:
  contents: write
  security-events: none
  pull-requests: none
  actions: read
  checks: none
  deployments: read
  issues: read
  packages: none
  repository-projects: none
  statuses: none


jobs:

  # TAG RELATED AS STEPS
  asSteps:
    name: TEST BRANCH AND TAGS AS STEPS
    runs-on: 'ubuntu-latest'
    steps:
      - id: branchname
        name: TEST BRANCH NAME
        uses: ministryofjustice/opg-github-actions/.github/actions/branch-name@v2.8.0-goversion.0
      - name: "BRANCH NAME: [${{steps.branchname.outputs.branch_name}} => ${{steps.branchname.outputs.safe}}]"
        run: echo "VERSION=${{steps.branchname.outputs.branch_name}} => ${{steps.branchname.outputs.safe}}"
      - id: latesttag
        name: TEST LATEST TAG
        uses: ministryofjustice/opg-github-actions/.github/actions/latest-tag@v2.8.0-goversion.0
        with:
          prerelease: true
          prerelease_suffix: ${{ steps.branchname.outputs.safe }}
          branch_name: ${{ steps.branchname.outputs.branch_name }}
      - name: "LATEST TAG: [${{steps.latesttag.outputs.last_release}} => ${{steps.latesttag.outputs.last_prerelease}}]"
        run: echo "LATEST TAG=${{steps.latesttag.outputs.last_release}} => ${{steps.latesttag.outputs.last_prerelease}}"
      - id: nexttag
        name: TEST NEXT TAG
        uses: ministryofjustice/opg-github-actions/.github/actions/next-tag@v2.8.0-goversion.0
        with:
          prerelease: true
          prerelease_suffix: ${{ steps.branchname.outputs.safe }}
          last_prerelease: ${{ steps.latesttag.outputs.last_prerelease }}
          last_release: ${{ steps.latesttag.outputs.last_release }}
          base_commitish: ${{steps.branchname.outputs.base_commitish}}
          head_commitish: ${{steps.branchname.outputs.head_commitish}}
          with_v: true
      - name: "NEXT TAG: [${{steps.nexttag.outputs.next_tag}}]"
        run: echo "NEXT TAG=${{steps.nexttag.outputs.next_tag}}"


  branchNameAsWorkflow:
    name: TEST BRANCH NAME AS WORKFLOW
    uses: ./.github/workflows/data-parse-branch-name.yml
    secrets: inherit

  # TERRAFORM VERSION
  terraformVersionAsStep:
    name: TEST TERRAFORM VERSION AS STEP
    runs-on: 'ubuntu-latest'
    steps:
      - id: version
        name: Get version
        uses: ministryofjustice/opg-github-actions/.github/actions/terraform-version@v2.8.0-goversion.0
        with:
          terraform_directory: "./terraform/account"
      - name: "VERSION: [${{steps.version.outputs.version}}]"
        run: echo "VERSION=${{steps.version.outputs.version}}"

  terraformVersionAsWorkflow:
    name: TEST TERRAFORM VERSION AS WORKFLOW
    uses: ./.github/workflows/data-parse-terraform-version.yml
    with:
      terraform_directory: "./terraform/account"
    secrets: inherit
